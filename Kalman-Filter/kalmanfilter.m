function [Fval,xHatHist] = kalmanfilter(p,Ta,etaSol,Qhvac,Ts,Y,TzInit,TwInit,QdistInit,N)
    
%Set the unknown parameter
    R0 = p(1);
    R1 = p(2);
    R2 = p(3);
    Cc = p(4);
    Cz = p(5);
    Cz2 = p(6);
    Ae = p(7);
    
 %Set the A B C D of the model
A = [-1/(Cz*R1) 0 0 0 0   0 0 0 0 0   1/(Cz*R1) 0 0 0 0    1/Cz 0 0 0 0   0 0 0 0 0; ...
     0 -2/(Cz*R1) 0 0 0   0 0 0 0 0   1/(Cz*R1) 1/(Cz*R1) 0 0 0    0 1/Cz 0 0 0   0 0 0 0 0; ...
     0 0 -2/(Cz*R1) 0 0   0 0 0 0 0   0 1/(Cz*R1) 1/(Cz*R1) 0 0   0 0 1/Cz 0 0  0 0 0 0 0; ...
     0 0 0 -1/(Cz*R1)-1/(Cz*R0) 0   0 0 0 0 0   0 0 1/(Cz*R1) 0 0   0 0 0 1/Cz 0   0 0 0 0 0; ...
     0 0 0 0 -2/(Cz*R1)   0 0 0 0 0   1/(Cz*R1) 0 0 1/(Cz*R1) 0   0 0 0 0 1/Cz    0 0 0 0 0;...
     ...
     0 0 0 0 0   -3/(Cz*R1) 0 0 0 0   1/(Cz*R1) 1/(Cz*R1) 0 1/(Cz*R1) 0   0 0 0 0 0   1/Cz 0 0 0 0;...
     0 0 0 0 0   0 -3/(Cz*R1) 0 0 0   0 1/(Cz*R1) 1/(Cz*R1) 0 1/(Cz*R1)   0 0 0 0 0   0 1/Cz 0 0 0;...
     0 0 0 0 0   0 0 -2/(Cz*R1)-1/(Cz*R0) 0 0   0 0 1/(Cz*R1) 0 1/(Cz*R1)   0 0 0 0 0   0 0 1/Cz 0 0;...
     0 0 0 0 0   0 0 0 -1/(Cz2*R2) 0   0 0 0 1/(Cz2*R2) 0   0 0 0 0 0   0 0 0 1/Cz2 0;...
     0 0 0 0 0   0 0 0 0 -1/(Cz2*R2)-1/(Cz2*R0)   0 0 0 0 1/(Cz2*R2)   0 0 0 0 0   0 0 0 0 1/Cz2;...
     ...
     1/(Cc*R1) 1/(Cc*R1) 0 0 1/(Cc*R1)   1/(Cc*R1) 0 0 0 0   -4/(Cc*R1) 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 1/(Cc*R1) 1/(Cc*R1) 0 0   1/(Cc*R1) 1/(Cc*R1) 0 0 0   0 -4/(Cc*R1) 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 1/(Cc*R1) 1/(Cc*R1) 0   0 1/(Cc*R1) 1/(Cc*R1) 0 0   0 0 -4/(Cc*R1) 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 1/(Cc*R1)   1/(Cc*R1) 0 0 1/(Cc*R1) 0   0 0 0 -2/(Cc*R1)-1/(Cc*R2) 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 1/(Cc*R1) 1/(Cc*R1) 0 1/(Cc*R1)   0 0 0 0 -2/(Cc*R1)-1/(Cc*R2)   0 0 0 0 0   0 0 0 0 0;...
     ...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     ...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0;...
     0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0   0 0 0 0 0];
 
 
 B = [1/Cz 0 0 0 0   0;...
      1/Cz 0 0 0 0   0;...
      0 1/Cz 0 0 0   0;...
      0 1/Cz 0 0 1/(Cz*R0)   0;...
      1/Cz 0 0 0 0   0;...
      ...
      1/Cz 0 0 0 0   0;...
      0 1/Cz 0 0 0   0;...
      0 1/Cz 0 0 1/(Cz*R0)   0;...
      0 0 1/Cz2 0 0   Ae/Cz2;...
      0 0 0 1/Cz2 1/(Cz2*R0)   Ae/Cz2;...
      ...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      ...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      ...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0;...
      0 0 0 0 0    0];
  
C = [1,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,1,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,1,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,1,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,0,1,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    
    0,0,0,0,0,   1,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,0,0,   0,1,0,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,0,0,   0,0,1,0,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,0,0,   0,0,0,1,0,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0;
    0,0,0,0,0,   0,0,0,0,1,   0,0,0,0,0,   0,0,0,0,0,   0,0,0,0,0];

    D=0;
    
    sys=ss(A,B,C,D);
    sys_est = c2d(sys,Ts);
    sys_est.TimeUnit = 'hour';

%Set the intial conditon
    uKal = [Qhvac';Ta';etaSol'];
    nkStates = 25;
    nkOutputs = 10;
    xInit = [TzInit;TwInit;QdistInit];
    
    x_hat_fin = xInit;
    P_k_fin = eye(nkStates);
% Set the covariance Q and R
    Q_k = (1E-7)*eye(nkStates);
    for i = 16:1:nkStates
        Q_k(i,i) = 1E-3;
    end
    R_k = (Q_k(25,25)/3)*eye(nkOutputs);
    
    xHatHist = zeros(nkStates,N);
    xHatHist(:,1) = x_hat_fin;
    
    I = eye(nkStates);

    %Calculate A B C D for Kalman Filter
    A_est = sys_est.A;
    B_est = sys_est.B;
    C_est = sys_est.C;
    D_est = sys_est.D;
    
    for k=2:1:N   
        Y_k = Y(:,k);
        U_k = uKal(:,k-1);

        P_k = A_est*P_k_fin*A_est' + Q_k;
        K_k = P_k*C_est'/(C_est*P_k*C_est'+R_k);        
        x_hat_fin = A_est*x_hat_fin + B_est*U_k + K_k*(Y_k - C_est*(A_est*x_hat_fin + B_est*U_k));       
        P_k_fin = (I - K_k*C_est)*P_k;

        xHatHist(:,k) = x_hat_fin; 
    end
    error = Y-C*xHatHist;   
    Fval = sum(abs(error(:)));
   
    xHatHist = (xHatHist)';
    fprintf('Processing\n');
end

        
    
    
    